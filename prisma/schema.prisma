// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"

}

enum UserRole {
  USER
  HOST
  ADMIN
}

enum EventStatus {
  OPEN
  FULL
  CANCELLED
  COMPLETED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}


model User {
  id              String       @id @default(cuid())
  fullname        String
  email           String       @unique
  password        String
  role            UserRole     @default(USER)

  bio             String?
  image           String?
  location        String?
  interests       String[]     @default([])

  rating          Float        @default(0)
  totalReviews    Int          @default(0)
  eventsHosted    Int          @default(0)
  eventsAttended  Int          @default(0)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  hostedEvents     Event[]        @relation("HostedEvents")
  joinedEvents     Participant[]  @relation("UserParticipants")
  reviewsWritten   Review[]       @relation("UserReviews")
  reviewsReceived  Review[]       @relation("HostReviews")
  payments         Payment[]

  auditLogs AuditLog[]
}

model Review {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  hostId    String

  rating    Int      @db.SmallInt
  comment   String?
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id])
  reviewer  User     @relation("UserReviews", fields: [userId], references: [id])
  host      User     @relation("HostReviews", fields: [hostId], references: [id])

  @@unique([eventId, userId])
  @@index([hostId])
}


model Event {
  id              String        @id @default(cuid())
  hostId          String

  title           String
  category        String
  description     String
  image           String?
  date            DateTime
  location        String
  maxParticipants     Int
  joiningFee      Float         @default(0)
  status          EventStatus   @default(OPEN)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  host            User          @relation("HostedEvents", fields: [hostId], references: [id])
  participants    Participant[] @relation("EventParticipants")
  reviews         Review[]
  payments        Payment[]

  @@index([hostId])
  @@index([status])
}


model Participant {
  id        String    @id @default(cuid())
  eventId   String
  userId    String
  joinedAt  DateTime  @default(now())

  // Relations
  event     Event     @relation("EventParticipants", fields: [eventId], references: [id])
  user      User      @relation("UserParticipants", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
}


model Payment {
  id        String        @id @default(cuid())
  eventId   String
  userId    String

  amount Decimal @db.Decimal(10,2)

  status    PaymentStatus @default(PENDING)
  provider  String        // Stripe, SSLCommerz, AmarPay
  txnId     String?

  createdAt DateTime      @default(now())

  // Relations
  event     Event         @relation(fields: [eventId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  target    String?   // eventId, reviewId, etc.
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}